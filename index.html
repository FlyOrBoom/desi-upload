<!doctype html>
<html>
	<head>
<style>
nav {
	display: flex;
}
ul {
	border: 1px solid black;
}
a {
	display: flex;
	justify-content: space-between;
	gap: .5rem;
}
</style>
	</head>
	<body>
		<h1>DESI filesystem on AWS</h1>
		<noscript>This page requires Javascript to view</noscript>
		<output>Loading...</output>
		<nav>
			<ul></ul>
			<ul></ul>
			<ul></ul>
			<ul></ul>
			<ul></ul>
			<ul></ul>
			<ul></ul>
			<ul></ul>
			<ul></ul>
			<ul></ul>
		</nav>
		<script> 
const bucketURL = "https://desidata.s3.amazonaws.com/"

const output = document.querySelector("output")
const lists = [...document.querySelectorAll("ul")]

let depth = 0
let key = ""

function query_url(query) {
	return bucketURL + "?" + new URLSearchParams(query)
}

async function query(key) {
	const response = await fetch(query_url({
		"list-type": 2,
		"prefix": key,
		"delimiter": "/",
	}))

	const data = new window.DOMParser()
		.parseFromString(await response.text(), "text/xml")
		.firstChild

	const files = [...data.querySelectorAll("Contents")]
		.map(file => ({
			key:		file.querySelector("Key").textContent,
			lastModified:	file.querySelector("LastModified").textContent,
			eTag:		file.querySelector("ETag").textContent,
			size:		file.querySelector("Size").textContent,
			storageClass:	file.querySelector("StorageClass").textContent,
		}))
		.map(file => ({
			...file,
			name:		file.key.replace(key, ""),
			isDir:		false,
		}))

	const dirs = [...data.querySelectorAll("CommonPrefixes")]
		.map(dir => ({
			key:		dir.querySelector("Prefix").textContent,
		}))
		.map(dir => ({
			...dir,
			name:		dir.key.slice(0, -1).replace(key, ""),
			isDir:		true,
		}))

	return ({ dirs, files })
}

function render({dirs, files }) {
	const children = [...dirs, ...files].map(node => {
		const item = document.createElement("li")

		const link = document.createElement("a")

		const name = document.createElement("span")
		const info = document.createElement("span")

		name.textContent = node.name

		if(node.isDir) {
			link.href = "#" + node.key
			link.addEventListener("click", async () => {
				depth = node.key.split("/").length - 1
				key = node.key
				console.log(node.key, depth)
				render(await query(node.key))
			})
			info.textContent = "/"
		} else {
			link.href = bucketURL + node.key
			link.setAttribute("download", "true")
			info.textContent = "(" + node.size + ")"
		}

		link.append(name, info)
		item.appendChild(link)
		return item
	})

	output.textContent = "$DESI_ROOT/" + key

	// remove original children
	lists[depth].innerHTML = ""

	// add new children
	lists[depth].append(...children)

	// update visibilities
	lists.forEach( (list, index) => {
		list.style.visibility = index > depth ? "hidden" : "visible"
	})
}

async function main() {
	render(await query(""))
}
main()
		</script>
	</body>
</html>
